name: Build, Test, Changelog, and Release Python Package

on:
  push:
    branches:
      - main

jobs:
  unit-tests:
    name: Test Python Package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.6.5" # pin a specific version is best practice
          enable-cache: true

      # install python in 
      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Run tests
        # For example, using `pytest`
        run: uv run pytest tests

  build-and-release:
    name: Generate Changelog, build, and release
    runs-on: ubuntu-latest
    needs: unit-tests  # This makes sure the build job runs first

    outputs:
      released: ${{ steps.changelog.outputs.skipped == 'false' }}

    steps:
      # Checkout the code
      - uses: actions/checkout@v4

      # Generate changelog
      - name: Conventional Changelog Action
        id: changelog
        uses: TriPSs/conventional-changelog-action@v3
        with:
          github-token: ${{ secrets.github_token }}
          create-summary: true

      
      - name: Set up uv
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Build package
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        run: |
          # VERSION=$(uvx dunamai from any --no-metadata --style pep440)
          VERSION=$(uvx dunamai from any --no-metadata --style pep440 | sed -E 's/\.post[0-9]+\.dev[0-9]+//')
          echo $VERSION
          uvx --from=toml-cli toml set --toml-path=pyproject.toml project.version $VERSION
          uv build

      - name: Create GitHub release and discussion
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        run: |
          gh release create $TAG $FILES \
            --title "$TAG" \
            --notes "$CHANGELOG" \
            --discussion-category "Announcements"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.changelog.outputs.tag }}
          CHANGELOG: ${{ steps.changelog.outputs.clean_changelog }}
          FILES: dist/*.tar.gz dist/*.whl

      - name: Upload dist artifacts
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

      - name: Push Files for GitHub Action
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        run: |
          git config user.name "Your GitHub Actions Bot"
          git config user.email "your-email@example.com"
          git add .
          git commit -m "Build package and update version"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  publish:
    name: publish to pypi
    needs: build-and-release
    if: >
      needs.build-and-release.result == 'success' &&
      needs.build-and-release.outputs.released == 'true'

    runs-on: ubuntu-latest

    environment: 
      name: pypi-env

    permissions: 
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v6

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Set up Python
      run: uv python install 3.13

    - name: Download dist artifacts
      uses: actions/download-artifact@v7
      with:
        name: dist
        path: dist

    - name: Smoke test (wheel)
      run: uv run --isolated --no-project --with dist/*.whl tests/smoke_test.py

    - name: Smoke test (source distribution)
      run: uv run --isolated --no-project --with dist/*.tar.gz tests/smoke_test.py

    - name: Publish
      run: uv publish
      








